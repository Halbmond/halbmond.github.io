<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Prefacemalloc lab 是 ICS 中具有挑战性的一个实验，笔者当时在 malloc lab 中取得了唯一的满分，下文简要阐述一些 malloc lab 的思路。  Preparation read through CS:APP Chapter 9 carefully and finish exercises  understand some concepts: implementat">
<meta property="og:type" content="article">
<meta property="og:title" content="How to get full points on malloc lab">
<meta property="og:url" content="http://yoursite.com/2016/12/28/How-to-get-full-points-on-malloc-lab/index.html">
<meta property="og:site_name" content="Halbmond">
<meta property="og:description" content="Prefacemalloc lab 是 ICS 中具有挑战性的一个实验，笔者当时在 malloc lab 中取得了唯一的满分，下文简要阐述一些 malloc lab 的思路。  Preparation read through CS:APP Chapter 9 carefully and finish exercises  understand some concepts: implementat">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://yoursite.com/images/How-to-get-full-points-on-malloc-lab/ics-malloc-lab-rank.png">
<meta property="og:updated_time" content="2018-07-06T10:21:46.344Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How to get full points on malloc lab">
<meta name="twitter:description" content="Prefacemalloc lab 是 ICS 中具有挑战性的一个实验，笔者当时在 malloc lab 中取得了唯一的满分，下文简要阐述一些 malloc lab 的思路。  Preparation read through CS:APP Chapter 9 carefully and finish exercises  understand some concepts: implementat">
<meta name="twitter:image" content="http://yoursite.com/images/How-to-get-full-points-on-malloc-lab/ics-malloc-lab-rank.png">






  <link rel="canonical" href="http://yoursite.com/2016/12/28/How-to-get-full-points-on-malloc-lab/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>How to get full points on malloc lab | Halbmond</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Halbmond</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/28/How-to-get-full-points-on-malloc-lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Vincent">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Halbmond">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">How to get full points on malloc lab
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-12-28 18:00:00" itemprop="dateCreated datePublished" datetime="2016-12-28T18:00:00+08:00">2016-12-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-07-06 18:21:46" itemprop="dateModified" datetime="2018-07-06T18:21:46+08:00">2018-07-06</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>malloc lab 是 ICS 中具有挑战性的一个实验，笔者当时在 malloc lab 中取得了唯一的满分，下文简要阐述一些 malloc lab 的思路。</p>
<p><img src="/images/How-to-get-full-points-on-malloc-lab/ics-malloc-lab-rank.png" alt="Rank"></p>
<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><ul>
<li><p>read through CS:APP Chapter 9 carefully and finish exercises</p>
<ul>
<li>understand some concepts:<ul>
<li>implementation<ul>
<li>implicit free list</li>
<li>explicit free list</li>
<li>segregated free list</li>
</ul>
</li>
<li>fit strategy<ul>
<li>first fit</li>
<li>next fit</li>
<li>best fit</li>
</ul>
</li>
<li>throughput</li>
<li>memory utilization<ul>
<li>payload</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>read through <code>malloclab-writeup.pdf</code></p>
</li>
<li><p>read two files in <code>malloclab-handout</code></p>
<ul>
<li><code>mm-naive.c</code></li>
<li><code>mm-textbook.c</code></li>
</ul>
</li>
</ul>
<h2 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h2><p>malloc lab 的目标是实现类似 GNU libc 的 <code>malloc</code>, <code>free</code>, <code>realloc</code>, <code>calloc</code>函数，即实现一个动态内存分配器，以理解堆的内存分配机制。</p>
<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><ul>
<li>Throughput (39%)<ul>
<li>we would like to maximize an allocator’s throughput, which is defined as the number of requests that it completes per unit time.</li>
</ul>
</li>
<li>memory utilization (61%)<ul>
<li>The peak ratio between the aggregate amount of memory used by the driver (i.e., allocated via malloc but not yet freed via free) and the size of the heap used by your allocator.</li>
</ul>
</li>
</ul>
<p>得分的评估包括两个方面</p>
<ul>
<li>吞吐量 (39%)</li>
</ul>
<ul>
<li>空间利用率 (61%) </li>
</ul>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>在malloc lab中，free操作会产生空闲的块，我们需要一个数据结构，支持这些块的插入，删除操作。并且在较少的时间内最大限度地利用空间。</p>
<p>如何维护这些空闲的块？</p>
<h4 id="Binary-Search-Tree"><a href="#Binary-Search-Tree" class="headerlink" title="Binary Search Tree"></a>Binary Search Tree</h4><p>为了提高空间利用率，我们考虑采用best fit策略，并使用平衡树维护。平衡树相比线段树，trie，附带的空间复杂度较低，并且能在$O(logn)$时间下完成插入，删除操作，具有十分不错的性质。</p>
<p>我们将平衡树的每个节点的结构体存入到空闲列表中。以 treap 为例，以如下这种方法，我们至少需要20 bytes的空闲链表来存储一个节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct node &#123;</span><br><span class="line">	node *left, *right, *next;</span><br><span class="line">	int size, random_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>left, right<ul>
<li>节点的左右子节点</li>
</ul>
</li>
<li>next<ul>
<li>指向一个链表，用来维护所有和该节点相同size的空闲块</li>
</ul>
</li>
<li>size<ul>
<li>空闲块的大小</li>
</ul>
</li>
<li>random_value<ul>
<li>节点分配到的随机值</li>
</ul>
</li>
</ul>
<h4 id="Linkedlist"><a href="#Linkedlist" class="headerlink" title="Linkedlist"></a>Linkedlist</h4><p>为了提高吞吐量，我们考虑用数组维护较小空闲块的链表头。</p>
<p>每次产生空闲块时，若</p>
<ul>
<li>空闲块的$size &lt;= LIMIT$，我们直接在这个数组中查找这些链表头<ul>
<li>必定能找到相应的链表头，我们直接往这个节点的链表中插入这个空闲块</li>
</ul>
</li>
<li>空闲块的$size &gt; LIMIT$，我们在平衡树中查找相应的链表头<ul>
<li>如果平衡树中存在相应$size$的节点，就往这个节点的链表中插入这个空闲块</li>
<li>如果平衡树中不存在相应$size$的节点，就往平衡树中插入这样的一个节点</li>
</ul>
</li>
</ul>
<h4 id="Fragment-Pool"><a href="#Fragment-Pool" class="headerlink" title="Fragment Pool"></a>Fragment Pool</h4><p>注意到trace 中的 exhaust.rep，boat.rep 等数据中，有大量小块的malloc, free操作，产生了大量无用的碎片。尤其是 8 bytes 的空闲块，一旦产生这样的碎片，除非coalesce，否则很难被再利用。</p>
<p>针对这一点，我们可以在heap的最前面开一个这样的池，管理这些碎片。</p>
<h2 id="Some-Tricks"><a href="#Some-Tricks" class="headerlink" title="Some Tricks"></a>Some Tricks</h2><h4 id="Trick-1"><a href="#Trick-1" class="headerlink" title="Trick 1"></a>Trick 1</h4><p>writeup中提到：堆的大小不会超过 $2^{32}$ 字节。</p>
<p>尽管 x86-64 机器下指针的空间是 8 bytes，但我们完全可以只记录4字节的偏移量完成寻址。</p>
<h4 id="Trick-2"><a href="#Trick-2" class="headerlink" title="Trick 2"></a>Trick 2</h4><p>一个 thou 的瓶颈是系统调用。感谢当初sy菊苣提醒:）</p>
<p>pku 服务器的主频非常低，提交到服务器上时系统调用简直慢到怀疑人生。</p>
<ul>
<li>一个优化：每次申请空间时，直接sbrk一大块，以减少系统调用次数。<ul>
<li>这是个空间与时间的 trade-off<ul>
<li>单次sbrk过少，Throughput 下降</li>
<li>单次sbrk过多，Space Utilization 大打折扣</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/05/Review-of-Psyche/" rel="next" title="Review of 《Psyche》">
                <i class="fa fa-chevron-left"></i> Review of 《Psyche》
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/10/MCDC-1/" rel="prev" title="Momenta Car Detection Challenge">
                Momenta Car Detection Challenge <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Vincent</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Preface"><span class="nav-number">1.</span> <span class="nav-text">Preface</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Preparation"><span class="nav-number">2.</span> <span class="nav-text">Preparation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Goal"><span class="nav-number">3.</span> <span class="nav-text">Goal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Evaluation"><span class="nav-number">4.</span> <span class="nav-text">Evaluation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis"><span class="nav-number">5.</span> <span class="nav-text">Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Binary-Search-Tree"><span class="nav-number">5.0.1.</span> <span class="nav-text">Binary Search Tree</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linkedlist"><span class="nav-number">5.0.2.</span> <span class="nav-text">Linkedlist</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fragment-Pool"><span class="nav-number">5.0.3.</span> <span class="nav-text">Fragment Pool</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Some-Tricks"><span class="nav-number">6.</span> <span class="nav-text">Some Tricks</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Trick-1"><span class="nav-number">6.0.1.</span> <span class="nav-text">Trick 1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Trick-2"><span class="nav-number">6.0.2.</span> <span class="nav-text">Trick 2</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vincent</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  










  





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

    
  


  
  

  

  

  

  

  

</body>
</html>
