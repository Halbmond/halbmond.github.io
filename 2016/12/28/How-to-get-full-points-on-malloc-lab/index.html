<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><title>How to get full points on malloc lab | アイス·セビリア</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="アイス·セビリア">
    <meta name="author" content="アイス·セビリア">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="アイス·セビリア" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
	
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    
    

    <!-- Custom stylesheet, (add custom styles here, always load last) -->
    <!-- Load our stylesheet for IE8 -->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- Google Webfonts (Monserrat 400/700, Open Sans 400/600) -->
    <link href='//fonts.useso.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>

    <!-- Load our fonts individually if IE8+, to avoid faux bold & italic rendering -->
    <!--[if IE]>
    <link href='http://fonts.useso.com/css?family=Montserrat:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:600' rel='stylesheet' type='text/css'>
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->










  
  
  

  
  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<!--
<body class="post-template">
<!-- hexo-inject:begin --><!-- hexo-inject:end -->-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="http://yume.ly/people/1059" target="_BLANK" class="animsition-link">YUME</a></li>
                    
                </ul>
            </li>
            
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/ACM/" class="animsition-link">ACM<small>(1)</small></a></li>
				    
				    <li><a href="/categories/ACM-ICPC/" class="animsition-link">ACM/ICPC<small>(0)</small></a></li>
				    
				    <li><a href="/categories/Computer-Science/" class="animsition-link">Computer Science<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Sound-Horizon/Resources/" class="animsition-link">Resources<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Review/" class="animsition-link">Review<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Sound-Horizon/" class="animsition-link">Sound Horizon<small>(1)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">所珍惜<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://sylfii.moe/" class="animsition-link">Sylfii</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">アイス·セビリア</a></li>
                            <li class="nolink"><span>Thousand </span>Regrets </li>
                            
                            <li><a href="https://github.com/Halbmond" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/ihalbmond" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->

        <!-- ============================ Hero Image =========================== -->

        <section id="hero" class="scrollme">
            <div class="container-fluid element-img" style="background: url(/img/bg_img.jpg) no-repeat center center fixed;background-size: cover">
                <div class="row">
                    <div class="col-xs-12 col-sm-8 col-sm-offset-2 col-md-8 col-md-offset-2 vertical-align cover boost text-center">
                        <div class="center-me animateme" data-when="exit" data-from="0" data-to="0.6" data-opacity="0" data-translatey="100">
                            <div>
                            	
                                <h2></h2>
                                <p></p>
				    			
                                <h2></h2>
                                <p></p>
				    			

                            </div>
                        </div>
                    </div>
                    <!-- // .col-md-12 -->
                </div>
                <div class="herofade beige-dk"></div>
            </div>
        </section>

        <!-- Height spacing helper -->
        <div class="heightblock"></div>
        <!-- // End height spacing helper -->

        <!-- ============================ END Hero Image =========================== -->
      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2016-12-28T10:00:00.000Z" itemprop="datePublished">
          2016-12-28
      </time>
    
</span>
                <h1>How to get full points on malloc lab</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>原本是受人所托，回来填坑。另一方面，也是想想这些事情，如果不赶紧记下来，将来就再也没办法找到了。这么一来，我这样恋旧的人大概会难过的吧。</p>
<p>——不然鬼知道这个原本定位慵懒小清新（?..）轻松日常的Blog，怎么会笔锋一转，写起了令人胃痛的malloc lab……</p>
<p>好啦好啦，接下来就开始正文吧</p>
<h2 id="Introduction-to-Computer-Systems"><a href="#Introduction-to-Computer-Systems" class="headerlink" title="Introduction to Computer Systems"></a>Introduction to Computer Systems</h2><p><a href="http://www.cs.cmu.edu/~./213/schedule.html" target="_blank" rel="noopener">Introduction to Computer Systems(ICS)</a> 这门课最早由cmu创立。2012年，北大信息科学技术学院与卡耐基梅隆大学计算机科学学院联合对该课程进行升级，并正式引入国内。</p>
<p>ICS 是北京大学信息科学技术学院的重点建设课程，课程由大班教学和小班研讨结合，并投入了大量师资。</p>
<p>malloc lab 是 ICS 中最具有挑战性的一个实验，笔者当时在 malloc lab 中取得了唯一的满分，下文简要阐述一些 malloc lab 的思路。</p>
<p><img src="/images/How-to-get-full-points-on-malloc-lab/ics-malloc-lab-rank.png" alt="Rank"></p>
<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><ul>
<li><p>read through CS:APP Chapter 9 carefully and finish exercises</p>
<ul>
<li>understand some concepts:<ul>
<li>implementation<ul>
<li>implicit free list</li>
<li>explicit free list</li>
<li>segregated free list</li>
</ul>
</li>
<li>fit strategy<ul>
<li>first fit</li>
<li>next fit</li>
<li>best fit</li>
</ul>
</li>
<li>throughput</li>
<li>memory utilization<ul>
<li>payload</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>read through <code>malloclab-writeup.pdf</code></p>
</li>
<li><p>read two files in <code>malloclab-handout</code></p>
<ul>
<li><code>mm-naive.c</code></li>
<li><code>mm-textbook.c</code></li>
</ul>
</li>
</ul>
<h2 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h2><p>malloc lab 的目标是实现类似 GNU libc 的 <code>malloc</code>, <code>free</code>, <code>realloc</code>, <code>calloc</code>函数，即实现一个动态内存分配器，以理解堆的内存分配机制。</p>
<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><ul>
<li>Throughput (39%)<ul>
<li>we would like to maximize an allocator’s throughput, which is defined as the number of requests that it completes per unit time.</li>
</ul>
</li>
<li>memory utilization (61%)<ul>
<li>The peak ratio between the aggregate amount of memory used by the driver (i.e., allocated via malloc but not yet freed via free) and the size of the heap used by your allocator.</li>
</ul>
</li>
</ul>
<p>得分的评估包括两个方面</p>
<ul>
<li>吞吐量 (39%)</li>
</ul>
<ul>
<li>空间利用率 (61%) </li>
</ul>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>在malloc lab中，free操作会产生空闲的块，我们需要一个数据结构，支持这些块的插入，删除操作。并且在较少的时间内最大限度地利用空间。</p>
<p>如何维护这些空闲的块？</p>
<h4 id="Binary-Search-Tree"><a href="#Binary-Search-Tree" class="headerlink" title="Binary Search Tree"></a>Binary Search Tree</h4><p>为了提高空间利用率，我们考虑采用best fit策略，并使用平衡树维护。平衡树相比线段树，trie，附带的空间复杂度较低，并且能在$O(logn)$时间下完成插入，删除操作，具有十分不错的性质。</p>
<p>我们将平衡树的每个节点的结构体存入到空闲列表中。以 treap 为例，以如下这种方法，我们至少需要20 bytes的空闲链表来存储一个节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct node &#123;</span><br><span class="line">	node *left, *right, *next;</span><br><span class="line">	int size, random_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>left, right<ul>
<li>节点的左右子节点</li>
</ul>
</li>
<li>next<ul>
<li>指向一个链表，用来维护所有和该节点相同size的空闲块</li>
</ul>
</li>
<li>size<ul>
<li>空闲块的大小</li>
</ul>
</li>
<li>random_value<ul>
<li>节点分配到的随机值</li>
</ul>
</li>
</ul>
<h4 id="Linkedlist"><a href="#Linkedlist" class="headerlink" title="Linkedlist"></a>Linkedlist</h4><p>为了提高吞吐量，我们考虑用数组维护较小空闲块的链表头。</p>
<p>每次产生空闲块时，若</p>
<ul>
<li>空闲块的size &lt;= LIMIT，我们直接在这个数组中查找这些链表头<ul>
<li>必定能找到相应的链表头，我们直接往这个节点的链表中插入这个空闲块</li>
</ul>
</li>
<li>空闲块的size &gt; LIMIT，我们在平衡树中查找相应的链表头<ul>
<li>如果平衡树中存在相应size的节点，就往这个节点的链表中插入这个空闲块</li>
<li>如果平衡树中不存在相应size的节点，就往平衡树中插入这样的一个节点</li>
</ul>
</li>
</ul>
<h4 id="Fragment-Pool"><a href="#Fragment-Pool" class="headerlink" title="Fragment Pool"></a>Fragment Pool</h4><p>注意到trace 中的 exhaust.rep，boat.rep 等数据中，有大量小块的malloc, free操作，产生了大量无用的碎片。尤其是 8 bytes 的空闲块，一旦产生这样的碎片，除非coalesce，否则很难被再利用。</p>
<p>针对这一点，我们可以在heap的最前面开一个这样的池，管理这些碎片。</p>
<h2 id="Some-Tricks"><a href="#Some-Tricks" class="headerlink" title="Some Tricks"></a>Some Tricks</h2><h4 id="Trick-1"><a href="#Trick-1" class="headerlink" title="Trick 1"></a>Trick 1</h4><p>writeup中提到：堆的大小不会超过 $2^{32}$ 字节。</p>
<p>尽管 x86-64 机器下指针的空间是 8 字节，但我们完全可以只记录4字节的偏移量完成寻址。</p>
<h4 id="Trick-2"><a href="#Trick-2" class="headerlink" title="Trick 2"></a>Trick 2</h4><p>一个 thou 的瓶颈是系统调用。感谢当初sy菊苣提醒:）</p>
<p>pku 服务器的主频非常低，提交到服务器上时系统调用简直慢到怀疑人生。</p>
<ul>
<li>一个优化：每次申请空间时，直接sbrk一大块，以减少系统调用次数。<ul>
<li>这是个空间与时间的 trade-off<ul>
<li>单次sbrk过少，Throughput 下降</li>
<li>单次sbrk过多，Space Utilization 大打折扣</li>
</ul>
</li>
</ul>
</li>
</ul>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    <a class="pull-left" href="/2018/05/28/pkucampus2018/" style="float: left;">
        ← Pku Campus 2018 Solution
    </a>
    
    
    <a class="pull-right" href="/2016/07/05/Review-of-Psyche/">
        Review of Psyche →
    </a>
    
</nav>

        <div class="duoshuo">
<div class="ds-thread" data-thread-key="2016/12/28/How-to-get-full-points-on-malloc-lab/" data-title="How to get full points on malloc lab" data-url="http://yoursite.com/2016/12/28/How-to-get-full-points-on-malloc-lab/"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"duoshuo_name"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By アイス·セビリア. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/Halbmond" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/ihalbmond" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
        
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };
    
    resizeHero();
    
    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
